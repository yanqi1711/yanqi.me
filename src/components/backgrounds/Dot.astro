---
// Dot.astro
---

<bg-dot
  class="fixed inset-0 -z-1 pointer-events-none dark:invert"
>
</bg-dot>

<script>
  import * as PIXI from "pixi.js";
  import { createNoise3D } from "simplex-noise";

  class BgDotElement extends HTMLElement {
    app: PIXI.Application | null = null;
    noise3D = createNoise3D();
    points: Array<{
      ox: number;
      oy: number;
      op: number;
      sprite: PIXI.Sprite;
    }> = [];

    async connectedCallback() {
      this.app = new PIXI.Application();
      await this.app.init({
        resizeTo: window,
        backgroundAlpha: 0,
        resolution: Math.min(
          window.devicePixelRatio,
          2,
        ),
        antialias: true,
        autoDensity: true,
      });

      this.appendChild(this.app.canvas);

      const SCALE = 200;
      const LENGTH = 10;
      const SPACING = 15;
      const { width, height } = this.app.screen;

      const dotGraphics = new PIXI.Graphics()
        .circle(0, 0, 1)
        .fill({ color: 0xcccccc, alpha: 1 });
      const dotTexture =
        this.app.renderer.generateTexture(
          dotGraphics,
        );

      const container = new PIXI.Container();
      this.app.stage.addChild(container);

      for (
        let x = -SPACING / 2;
        x < width + SPACING;
        x += SPACING
      ) {
        for (
          let y = -SPACING / 2;
          y < height + SPACING;
          y += SPACING
        ) {
          const sprite = new PIXI.Sprite(
            dotTexture,
          );
          sprite.anchor.set(0.5);
          sprite.x = x;
          sprite.y = y;

          container.addChild(sprite);

          this.points.push({
            ox: x,
            oy: y,
            op: Math.random() * 0.5 + 0.5,
            sprite: sprite,
          });
        }
      }

      this.app.ticker.add(() => {
        const t = Date.now() / 10000;

        for (
          let i = 0;
          i < this.points.length;
          i++
        ) {
          const p = this.points[i];

          // 计算噪声
          const n1 = this.noise3D(
            p.ox / SCALE,
            p.oy / SCALE,
            t,
          );
          const rad = n1 * Math.PI * 2;

          const n2 = this.noise3D(
            p.ox / SCALE,
            p.oy / SCALE,
            t * 2,
          );
          const len = (n2 + 1) * 0.5 * LENGTH;

          p.sprite.x = p.ox + Math.cos(rad) * len;
          p.sprite.y = p.oy + Math.sin(rad) * len;
          p.sprite.alpha =
            (Math.abs(Math.cos(rad)) * 0.8 +
              0.2) *
            p.op;
        }
      });
    }

    disconnectedCallback() {
      if (this.app) {
        try {
          const access =
            this.app.renderer.accessibility;
          if (
            access &&
            access.div &&
            access.div.parentNode
          ) {
            access.div.parentNode.removeChild(
              access.div,
            );
          }

          this.app.destroy(true, {
            children: true,
            texture: true,
            textureSource: true,
          });
        } catch (error) {
          if (
            !(
              error instanceof DOMException &&
              error.name === "NotFoundError"
            )
          ) {
            console.error(
              "Unexpected PixiJS error:",
              error,
            );
          }
        } finally {
          this.app = null;
        }
      }
    }
  }

  if (!customElements.get("bg-dot")) {
    customElements.define("bg-dot", BgDotElement);
  }
</script>
